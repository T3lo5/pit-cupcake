# ==============================================================================
# RENDER.YAML - INFRASTRUCTURE AS CODE PARA CUPCAKES APPLICATION
# ==============================================================================
# Este arquivo permite provisionar toda a infraestrutura no Render de uma vez:
# - AplicaÃ§Ã£o Full Stack (API + Web)
# - Banco de dados PostgreSQL
# - ConfiguraÃ§Ãµes automÃ¡ticas
# ==============================================================================

services:
  # ==============================================================================
  # APLICAÃ‡ÃƒO PRINCIPAL - Full Stack (API + Web)
  # ==============================================================================
  - type: web
    name: cupcakes-app
    runtime: docker
    plan: starter  # Pode ser: starter, standard, pro
    region: oregon  # Escolha: oregon, frankfurt, singapore
    branch: main
    rootDir: .
    dockerfilePath: ./Dockerfile
    dockerContext: .
    
    # ConfiguraÃ§Ãµes de build
    buildCommand: docker build -t cupcakes-app .
    
    # ConfiguraÃ§Ãµes de runtime
    startCommand: /app/start.sh
    
    # Health check
    healthCheckPath: /health
    
    # ConfiguraÃ§Ãµes de auto-deploy
    autoDeploy: true
    
    # VariÃ¡veis de ambiente
    envVars:
      # ConfiguraÃ§Ãµes gerais
      - key: NODE_ENV
        value: production
      
      - key: PORT
        value: 8080
      
      # Database (serÃ¡ preenchido automaticamente pelo Render)
      - key: DATABASE_URL
        fromDatabase:
          name: cupcakes-db
          property: connectionString
      
      # JWT Secret (gerado automaticamente pelo Render)
      - key: JWT_SECRET
        generateValue: true
      
      # CORS - serÃ¡ a prÃ³pria URL do serviÃ§o
      - key: CORS_ORIGIN
        fromService:
          type: web
          name: cupcakes-app
          property: host
      
      # ConfiguraÃ§Ãµes da API
      - key: API_VERSION
        value: v1
      
      - key: RATE_LIMIT_WINDOW_MS
        value: 900000
      
      - key: RATE_LIMIT_MAX_REQUESTS
        value: 100
      
      # ConfiguraÃ§Ãµes do Prisma
      - key: PRISMA_CLI_QUERY_ENGINE_TYPE
        value: binary
      
      # URL da API para o frontend (mesmo serviÃ§o)
      - key: VITE_API_URL
        fromService:
          type: web
          name: cupcakes-app
          property: host
    
    # ConfiguraÃ§Ãµes de recursos
    disk:
      name: cupcakes-app-disk
      sizeGB: 1
      mountPath: /app/data
    
    # ConfiguraÃ§Ãµes de rede
    domains:
      - name: cupcakes-app.onrender.com  # Substitua pelo seu domÃ­nio personalizado se tiver

  # ==============================================================================
  # BANCO DE DADOS POSTGRESQL
  # ==============================================================================
databases:
  - name: cupcakes-db
    databaseName: cupcakes
    user: cupcakes_user
    plan: starter  # Pode ser: starter, standard, pro
    region: oregon  # Mesma regiÃ£o da aplicaÃ§Ã£o
    version: "15"  # VersÃ£o do PostgreSQL
    
    # ConfiguraÃ§Ãµes de backup (apenas em planos pagos)
    # ipAllowList:
    #   - source: 0.0.0.0/0
    #     description: Allow all connections (nÃ£o recomendado para produÃ§Ã£o)

# ==============================================================================
# CONFIGURAÃ‡Ã•ES GLOBAIS
# ==============================================================================

# ConfiguraÃ§Ãµes de notificaÃ§Ã£o (opcional)
# notifications:
#   - type: email
#     emails:
#       - seu-email@exemplo.com
#     events:
#       - deploy-succeeded
#       - deploy-failed

# ==============================================================================
# INSTRUÃ‡Ã•ES DE USO
# ==============================================================================

# Para usar este arquivo:
# 1. FaÃ§a commit deste arquivo na raiz do seu repositÃ³rio
# 2. No Render Dashboard, vÃ¡ em "Blueprint" -> "New Blueprint"
# 3. Conecte seu repositÃ³rio
# 4. O Render lerÃ¡ este arquivo e criarÃ¡ todos os recursos automaticamente
# 5. Aguarde o deploy completar (pode levar alguns minutos)

# ==============================================================================
# RECURSOS CRIADOS AUTOMATICAMENTE
# ==============================================================================

# Este arquivo criarÃ¡:
# âœ… 1 Web Service (cupcakes-app) rodando na porta 8080
# âœ… 1 PostgreSQL Database (cupcakes-db)
# âœ… Todas as variÃ¡veis de ambiente configuradas
# âœ… ConexÃ£o automÃ¡tica entre app e banco
# âœ… Health checks configurados
# âœ… Auto-deploy habilitado

# ==============================================================================
# URLS FINAIS
# ==============================================================================

# ApÃ³s o deploy, vocÃª terÃ¡:
# ğŸŒ Frontend: https://cupcakes-app.onrender.com
# ğŸ”Œ API: https://cupcakes-app.onrender.com/api
# ğŸ’¾ Database: Conectado automaticamente via DATABASE_URL

# ==============================================================================
# CUSTOS ESTIMADOS (Plano Starter)
# ==============================================================================

# Web Service (Starter): $7/mÃªs
# PostgreSQL (Starter): $7/mÃªs
# Total estimado: $14/mÃªs

# Nota: Planos gratuitos tÃªm limitaÃ§Ãµes de tempo de atividade
# Para produÃ§Ã£o, recomenda-se usar planos pagos